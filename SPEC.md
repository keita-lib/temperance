# Temperance 仕様書（MVP）
Version: 0.1  
Repo/Project: temperance  
Deploy: Vercel  
Platform: Next.js PWA（スマホでその場入力最優先）  
Data: Local-first（IndexedDB + Dexie）  
Mentor: Lv.1のみ（辞書Tips）

---

## 1. コンセプト
Temperanceは「節制利益」を獲得していくゲームである。  
節約・家計簿・投資管理ではない。  
ユーザーはスマホでその場で即入力し、節制利益が累積していく快感を得る。

- 主役: 金額目標（例: 4,000,000円）
- 目的: 節制利益（本来なら支出していた金額）を積み上げ、達成率と累積を可視化する

---

## 2. 用語定義
- **節制利益**: 本来なら支出していた金額を、理性的な判断で支出せず「利益として獲得」した金額
- **獲得**: 節制利益をログとして保存する行為（ボタン文言は「獲得する」）
- **メンター（Lv.1）**: 「節制利益獲得テクニック」を短文で“たまに”表示する機能

禁止ワード（UIで使わない）:
- 節約、我慢、管理、診断、反省、〜すべき

推奨ワード:
- 節制利益、獲得、累積、目標、判断

---

## 3. アクセス/配布
- VercelにデプロイしてURLを提供
- PWAとしてインストール可能（Android Chrome:「ホーム画面に追加」）
- ローカルファースト: オフラインでも記録できる

---

## 4. 技術要件（MVP）
- Next.js（App Router） + TypeScript
- IndexedDB（Dexie）をローカルDBとして使用
- PWA対応（manifest + service worker最小）
- バックエンド/認証/クラウド同期は実装しない

---

## 5. MVPスコープ（実装する）
### 5.1 画面
- ホーム（ダッシュボード）
- 獲得（追加）
- 履歴（MVPは簡易でOK）
- 設定（目標金額・プリセット編集・バックアップ）

### 5.2 機能
- 目標金額の設定（必須）
- 都度入力（プリセット選択 or 自由入力）
- 今日の節制利益合計の表示
- 累積節制利益の表示
- 達成率（%）・残額（円）
- 予測到達日（直近7日平均で推定、データ不足なら非表示）
- 累積グラフ表示
- メンターLv1（短文Tipsカードを低頻度で表示）
- バックアップ: JSONエクスポート/インポート（必須）

---

## 6. 非スコープ（MVPではやらない）
- ログイン/アカウント
- クラウド同期
- 投資先や投資記録、投資頻度管理、利回り等
- メンターLv2（オンデバイスLLM）
- メンターLv3（クラウドLLM）
- 位置情報や外部センサー連携
- プッシュ通知（常時通知）

---

## 7. UX要件（最重要）
### 7.1 入力導線（3秒）
- ホームに「＋節制利益を獲得」ボタン（大きい）
- 追加画面でプリセットを金額付きで一覧表示
- 1タップで即獲得（必要なら金額編集）
- 獲得後も追加画面に留まり、連続入力できる（ホームはユーザー操作で戻る）
- 誤タップ対策は「Undo」トースト（Confirmは原則しない）

### 7.2 トーン
- 説教しない
- 判断を奪わない
- 文章は短く（1〜2文）

### 7.3 表示頻度
- メンターTipsは 1日最大1〜3回（設定で制御可能、デフォルト1回）
- 起動直後 or 獲得直後に文脈一致で出す（乱発しない）

---

## 8. 画面仕様
### 8.1 ホーム（/）
表示要素（上→下）
1) **今日の節制利益（円）**: 今日0:00〜現在までの合計  
2) **累積節制利益（円）**: 全ログ合計  
3) **目標カード**
   - 目標金額
   - 達成率 = 累積 / 目標 * 100（小数1桁）
   - 残額 = 目標 - 累積（0未満なら0表示）
   - 予測到達日（任意表示）
4) **累積グラフ（折れ線）**
5) **「＋節制利益を獲得」ボタン**
6) **メンターTipsカード**（条件を満たす時のみ表示）

目標未設定時:
- ホーム上部に「目標金額を設定してください」導線を表示（設定へ遷移）

---

### 8.2 獲得（/add）
- プリセット一覧（カテゴリ見出し + 金額表示）
- 項目タップで即獲得（Confirmなし）
- 金額編集UI（任意）：タップ後に小さなモーダルで金額変更可能
- 自由入力:
  - ラベル（任意）
  - 金額（必須）
  - カテゴリ（任意、デフォルトother）
- 獲得後もこの画面に留まり、続けて入力できる（必要に応じてナビでホームへ戻る）

---

### 8.3 履歴（/history）
- 日付ごとの合計
- 直近のログ一覧（最新が上）
- 削除（任意）：スワイプ削除 or メニューから削除

---

### 8.4 設定（/settings）
- 目標金額の設定/変更（必須）
- メンター表示頻度（0/1/2/3回）※デフォルト1
- プリセット金額編集（必須）
- データの書き出し（JSON）
- データの読み込み（JSON）
- データ初期化（危険操作、二重確認）

---

## 9. メンターLv1仕様（Tips）
### 9.1 出力形式
- 1〜2文
- 60文字程度（目安）
- 説教しない、断定しない、〜すべき禁止

例:
- 「自販機の前ですか？ 水で +¥120 の節制利益。」
- 「見た目は質素でも、心は錦。」
- 「やらないと決める。それは人生を決めること。」

### 9.2 表示条件（実装しやすいルール）
- その日の表示回数が上限未満
- 直近の獲得カテゴリに一致するTipsを優先（なければランダム）
- 起動時: 1日1回まで（上限に含める）
- 獲得直後: そのカテゴリTipsがあれば1回まで（上限に含める）

### 9.3 Tipsデータ
- アプリに同梱（JSON）
- 将来、ユーザー追加Tipsに拡張できる構造にする

---

## 10. データ設計（IndexedDB / Dexie）
### 10.1 logs
- id: string (uuid)
- ts: number (epoch ms)
- amount: number (integer yen, >0)
- category: string (drink/food/alcohol/gamble/subscription/other etc)
- label: string (preset name or free label)
- note?: string (optional)

Index:
- ts
- category

### 10.2 presets
- id: string
- category: string
- label: string
- defaultAmount: number (integer yen)
- sortOrder: number
- isActive: boolean

### 10.3 settings (key-value)
- key: string (e.g., goalAmount, mentorMaxPerDay)
- value: any (store as JSON)

### 10.4 tips
- id: string
- category?: string
- text: string
- weight?: number (optional)

### 10.5 meta（内部管理）
- key: string (lastTipShownAt, tipShownCount_YYYYMMDD, etc)
- value: any

---

## 11. 集計仕様
### 11.1 今日の節制利益
- todayStart = ローカルタイムで当日0:00
- sum(amount) where ts >= todayStart

### 11.2 累積
- sum(amount) across all logs

### 11.3 達成率/残額
- achievedPct = min(100, (cumulative / goalAmount) * 100)
- remaining = max(0, goalAmount - cumulative)

### 11.4 予測到達日（直近7日平均）
- last7DaysTotal = sum(amount) where ts >= now - 7days
- avgPerDay = last7DaysTotal / 7
- 条件:
  - avgPerDay > 0
  - 直近7日にログが1件以上
- daysToGoal = remaining / avgPerDay
- eta = today + ceil(daysToGoal) days
- 表示文言は断定しない:
  - 「このペースが続くと、YYYY/MM/DD頃に到達」

---

## 12. バックアップ仕様（必須）
### 12.1 エクスポート（JSON）
- logs, presets, settings, tips, meta を含める
- ファイル名例: temperance-backup-YYYYMMDD.json

### 12.2 インポート（JSON）
- 既存データに上書き（基本は「置換」）
- 置換前に確認ダイアログ
- 失敗時は何もしない（可能ならトランザクション的に）

---

## 13. PWA要件
- app/manifest.ts を用意
- icons: 192/512/maskable
- display: standalone
- start_url: "/"
- service worker（キャッシュ最小でOK）
- オフライン時でも最低限UIが開く（ホーム表示 + ローカルDBで動作）

---

## 14. デプロイ（Vercel）
- main ブランチをProduction
- 環境変数はMVPでは不要
- Pixel 6（Android Chrome）で「ホーム画面に追加」導線が成立すること

---

## 15. 初期プリセット（例）
カテゴリ: drink
- ペットボトル飲料: 120
- コーヒー: 180

カテゴリ: food
- 買い食い: 300
- 外食ランチ: 1320
- ポテトチップス: 180
- おつまみ（サラミ等）: 350
- ソフトクリーム: 450

カテゴリ: alcohol
- ビール・チューハイ（1本）: 220
- 飲み会のお誘い（自腹）: 5000

カテゴリ: gamble
- パチンコ/スロット: 10000
- 競馬: 5000
- 競輪: 5000
- 宝くじ: 300

カテゴリ: other
- 雑誌: 800
- マンガ本: 550
- タバコ（1箱）: 600

※ 金額はユーザーが編集できること（設定画面）

---

## 16. 受け入れ基準（Acceptance Criteria）
- Pixel 6（Android Chrome）で「ホーム画面に追加」して起動できる
- オフライン（機内モード）でもログを獲得でき、ホームの数値が更新される
- 目標金額を設定しないとホームで促される（導線）
- 追加 → 獲得 → ホーム反映が体感1秒以内（基本ローカル処理のみ）
- 累積グラフが表示される（最低限、日次点を線で結べばOK）
- JSONエクスポート/インポートが動作し、データが復元できる
- メンターTipsが「たまに」出る（乱発しない、設定で回数制御）

---

## 17. ディレクトリ構成（推奨・MVP）
※ 実装者（Codex）が迷わないための指針。必須ではないが推奨。

temperance/
├─ app/
│ ├─ page.tsx # ホーム
│ ├─ add/
│ │ └─ page.tsx # 獲得
│ ├─ history/
│ │ └─ page.tsx # 履歴
│ ├─ settings/
│ │ └─ page.tsx # 設定
│ ├─ manifest.ts # PWA manifest
│ └─ layout.tsx
├─ lib/
│ ├─ db.ts # Dexie DB 定義
│ ├─ aggregates.ts # 集計ロジック（今日/累積/予測）
│ ├─ tips.ts # メンターTips選択ロジック
│ └─ backup.ts # JSON export/import
├─ data/
│ ├─ presets.json # 初期プリセット
│ └─ tips.json # 初期メンターTips
├─ public/
│ └─ icons/
│ ├─ icon-192.png
│ ├─ icon-512.png
│ └─ maskable-512.png
├─ SPEC.md
├─ AGENTS.md
└─ README.md


---

## 18. 初回起動フロー（UX規定）
### 初回のみ
1. アプリ起動
2. 目標金額が未設定の場合：
   - モーダル or 専用カードで「目標金額を設定してください」
3. 目標設定完了後：
   - ホームへ遷移
   - メンターTipsを**1回だけ表示可**

### 2回目以降
- 直接ホーム表示
- 目標設定の再要求はしない

---

## 19. エラー/例外時の振る舞い
- DB初期化失敗時：
  - 画面にエラーを出さず、再初期化を試みる
- 集計不能時（データ不足）：
  - 数値は 0 / 非表示
  - 文言で補足しない（静かに）

---

## 20. パフォーマンス要件（体感）
- 獲得ボタン押下 → 反映：**1秒以内**
- DB読み込み → ホーム表示：**即時**
- グラフ描画：**遅延させても可**（数値優先）

---

## 21. セキュリティ/プライバシー方針
- 個人情報は扱わない
- 位置情報・連絡先・端末IDは取得しない
- データは端末内にのみ保存
- 外部送信はしない（MVP）

---

## 22. 将来拡張の余地（実装しない）
※ SPEC.md として明示するが、**MVPでは触らない**

- メンターLv2（オンデバイスLLM）
- メンターLv3（クラウドLLM）
- 複数端末同期
- アカウント/認証
- 有料プラン
- 通知（プッシュ/リマインド）

---

## 23. 開発方針（Codex向け最終指針）
- 仕様にない改善提案は不要
- 動くものを最優先
- 「美しさ」より「続けられるUX」
- 節制利益という言葉と思想を壊さない

---

## 24. 最終メッセージ（仕様としての哲学）
> やらないと決める。  
> それは、あなた自身が  
> 自分の人生を決断しているということ。
